<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TGN Profile</title>
  <link rel="icon" type="image/png" sizes="16x16" href="assets/images/favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="assets/images/favicon-32x32.png">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/main.css">
  <link rel="stylesheet" href="/assets/css/custom.css">
</head>
<body>
  <header>
    <div class="header-container">
      <a href="../../" class="header-title" style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 8px;">
        <img src="assets/images/favicon-32x32.png" alt="TGN Logo" width="24" height="24" style="filter: drop-shadow(0 0 2px rgba(0,0,0,0.5))">
        <span>TGN</span>
      </a>
      <div class="user-panel" id="userPanel">
        <!-- Content will be dynamically generated -->
      </div>
    </div>
  </header>

  <div class="container">
    <div class="main-container">
      <div class="profile-container">
        <div class="profile-header">
          <div class="profile-avatar" id="profileAvatar">
            <div id="avatarImage" class="avatar-container"></div>
            <input type="file" id="avatarUpload" accept="image/*" style="display:none">
          </div>
          <h1 id="profileUsername">Loading...</h1>
          <div id="profileRoleBadge" class="role-badge">Member</div>
        </div>

        <div class="profile-section">
          <h2>Character Information</h2>
          <div class="form-group">
            <label for="characterName">Character Name</label>
            <input type="text" id="characterName" placeholder="Your in-game character name">
          </div>
          <div class="form-group">
            <label for="characterClass">Class</label>
            <input type="text" id="characterClass" placeholder="Warrior/Mage/Archer etc.">
          </div>
        </div>
				
				<div class="profile-section">
					<h2>Gear Information</h2>
					<div class="form-group">
						<label for="ap">Attack Power (AP)</label>
						<input type="number" id="ap" placeholder="e.g. 280" min="0">
					</div>
					<div class="form-group">
						<label for="dp">Defense Power (DP)</label>
						<input type="number" id="dp" placeholder="e.g. 350" min="0">
					</div>
					<div class="form-group">
						<label for="gearScore">Total Gear Score (AP + DP)</label>
						<input type="number" id="gearScore" placeholder="Calculated automatically" readonly>
					</div>
				</div>

        <div class="profile-section">
            <h2>Screenshot/Hover Card Background</h2>
            <div class="form-group">
                <div style="display: flex; gap: 1.5rem; flex-wrap: wrap;">
                    <div id="characterScreenshotContainer" class="screenshot-container" style="flex: 1; min-width: 300px;">
                        <img id="characterScreenshotPreview" src="" alt="Character screenshot" style="display: none; max-width: 100%; max-height: 300px; border-radius: var(--radius-sm);">
                        <div id="screenshotPlaceholder" class="screenshot-placeholder">
                            <span>No screenshot uploaded</span>
                        </div>
                        <input type="file" id="characterScreenshot" accept="image/*" style="display: none;">
                        <button id="uploadScreenshotBtn" class="btn btn-secondary" style="margin-top: 1rem;">Upload Screenshot</button>
                    </div>
                    
                    <div id="hoverCardPreviewContainer" style="flex: 0.65; min-width: 300px;">
                        <h3 style="margin-bottom: 1rem; color: var(--text-secondary);">Preview</h3>
                        <div id="hoverCardPreview" class="profile-hover-card" style="position: relative; opacity: 1; display: block; width: 100%; height: 225px; pointer-events: auto;">
                            <div class="hover-card-header">
                                <div class="hover-avatar-container">
                                    <img id="previewHoverAvatar" class="hover-avatar" src="" alt="Avatar" style="display:none">
                                    <div id="previewDefaultAvatar" class="default-avatar" style="display:none"></div>
                                </div>
                                <div class="hover-name-role">
                                    <h3 id="previewHoverUsername"></h3>
                                    <div id="previewHoverClass" class="hover-class"></div>
                                    <span id="previewHoverRoleBadge" class="role-badge"></span>
                                </div>
                            </div>
                            <div class="hover-card-body">
                                <div class="hover-stats">
                                    <div class="hover-stat">
                                        <span>AP</span>
                                        <strong id="previewHoverAP">0</strong>
                                    </div>
                                    <div class="hover-stat">
                                        <span>DP</span>
                                        <strong id="previewHoverDP">0</strong>
                                    </div>
                                    <div class="hover-stat">
                                        <span>GS</span>
                                        <strong id="previewHoverGS">0</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <p style="margin-top: 0.5rem; color: var(--text-tertiary); font-size: 0.9rem;">
                            This gives you an idea of how your profile will look when others hover your name.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div class="profile-section">
          <h2>Player Bio</h2>
          <div class="form-group">
            <textarea id="playerBio" rows="5" placeholder="Tell us about yourself and your playstyle..."></textarea>
          </div>
        </div>

        <div class="profile-actions">
          <button id="backBtn" class="btn btn-secondary">Back to Home</button>
          <button id="saveProfileBtn" class="btn btn-primary">Save Profile</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script>
    // Initialize Firebase with your existing config
    const firebaseConfig = {
      apiKey: "AIzaSyANFiNgI5AElip2yg1s1j8X_C_fySX0b38",
      authDomain: "tgn-roster.firebaseapp.com",
      databaseURL: "https://tgn-roster-default-rtdb.firebaseio.com",
      projectId: "tgn-roster",
      storageBucket: "tgn-roster.appspot.com",
      appId: "1:680550686349:web:bf8d53910264c3a5004cc4"
    };
    
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const auth = firebase.auth();

    // Profile Management
    document.addEventListener('DOMContentLoaded', () => {
      // Back button functionality
      document.getElementById('backBtn').addEventListener('click', () => {
        window.location.href = '../../index.html';
      });

      auth.onAuthStateChanged(async user => {
          if (!user) {
              window.location.href = '../../index.html'; // Redirect to home page
              return;
          }
      
          try {
              const userSnapshot = await database.ref(`users/${user.uid}`).once('value');
              const userData = userSnapshot.val();
      
              if (!userData) {
                  alert('User data not found.');
                  auth.signOut();
                  return;
              }
      
              // Set global currentUser
              window.currentUser = {
                  uid: user.uid,
                  username: userData.username || 'Unknown',
                  role: userData.role || 'member',
                  photoURL: userData.photoURL || '',
                  isAdmin: userData.isAdmin || false
              };
    
          // Update user panel in header
          updateUserPanel();
          
          // Now load profile
          loadProfile(user.uid);
    
          document.getElementById('profileAvatar').addEventListener('click', () => {
            document.getElementById('avatarUpload').click();
          });
      
          document.getElementById('avatarUpload').addEventListener('change', (e) => {
            if (e.target.files && e.target.files[0]) {
              uploadAvatar(user.uid, e.target.files[0]); // Use user.uid directly
            }
          });
    
          // Save profile
          document.getElementById('saveProfileBtn').addEventListener('click', () => {
            saveProfile(user.uid);
          });
    
        } catch (error) {
          console.error('Failed to load user profile:', error);
          auth.signOut();
        }
      });
    });

    function updateUserPanel() {
        const userPanel = document.getElementById('userPanel');
        if (!userPanel || !currentUser) return;
        
        userPanel.innerHTML = `
            ${currentUser?.isAdmin || ['guild-master', 'advisor', 'staff', 'officer'].includes(currentUser?.role) ? 
              `<button class="admin-panel-btn" onclick="localStorage.setItem('openAdminModal', 'true'); window.location.href='../../index.html'">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
                </svg>
                Admin Panel
              </button>` : ''}
        `;
    }

    function createLetterAvatar(name) {
      const firstLetter = name.charAt(0).toUpperCase();
      const colors = ['#FFB900', '#FF8C00', '#F7630C', '#CA5010', '#DA3B01', 
                     '#EF6950', '#D13438', '#FF4343', '#E74856', '#E81123'];
      const color = colors[firstLetter.charCodeAt(0) % colors.length];
      
      return `
        <div class="letter-avatar" style="background:${color}">
          ${firstLetter}
        </div>
      `;
    }
    
    async function loadProfile(uid) {
        try {
            const snapshot = await database.ref(`profiles/${uid}`).once('value');
            const profile = snapshot.val() || {};
            
            // Set basic info
            document.getElementById('profileUsername').textContent = currentUser.username;
            
            // Set role badge
            const roleBadge = document.getElementById('profileRoleBadge');
            roleBadge.className = `role-badge ${currentUser.role}`;
            roleBadge.textContent = currentUser.role.split('-').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
            
            // Set avatar - use letter or custom avatar
            const avatarContainer = document.getElementById('avatarImage');
            if (currentUser.photoURL) {
                // Show uploaded avatar
                avatarContainer.innerHTML = `
                    <img src="${currentUser.photoURL}" 
                             class="custom-avatar"
                             onerror="showLetterAvatar()">
                `;
            } else {
                // Show letter avatar if no custom one exists
                showLetterAvatar();
            }
            
            function showLetterAvatar() {
                const name = currentUser.username || 'U';
                const firstLetter = name.charAt(0).toUpperCase();
                const colors = ['#FFB900', '#FF8C00', '#F7630C', '#CA5010'];
                const color = colors[firstLetter.charCodeAt(0) % colors.length];
                
                avatarContainer.innerHTML = `
                    <div class="letter-avatar" style="background:${color}">
                        ${firstLetter}
                    </div>
                `;
            }
            
            // Fill form fields
            document.getElementById('characterName').value = profile.characterName || '';
            document.getElementById('characterClass').value = profile.characterClass || '';
            document.getElementById('playerBio').value = profile.bio || '';
            
            // Load BDO gear info
            document.getElementById('ap').value = profile.ap || '';
            document.getElementById('dp').value = profile.dp || '';
            updateGearScore(); // Calculate initial gear score
            
            // Load character screenshot
            if (profile.characterScreenshot) {
                const screenshotPreview = document.getElementById('characterScreenshotPreview');
                screenshotPreview.src = profile.characterScreenshot;
                screenshotPreview.style.display = 'block';
                document.getElementById('screenshotPlaceholder').style.display = 'none';
                
                // Update hover card preview
                updateHoverCardPreview(profile);
            }
            
            // Update hover card preview with current data
            updateHoverCardPreview(profile);
            
        } catch (error) {
            console.error('Error loading profile:', error);
            alert('Error loading profile: ' + error.message);
        }
    }
    
    // Add this new function to update the hover card preview
    function updateHoverCardPreview(profile) {
        // Update username
        document.getElementById('previewHoverUsername').textContent = currentUser.username;
        
        // Update role badge
        const roleBadge = document.getElementById('previewHoverRoleBadge');
        roleBadge.className = `role-badge ${currentUser.role}`;
        roleBadge.textContent = currentUser.role.split('-').map(word => 
            word.charAt(0).toUpperCase() + word.slice(1)
        ).join(' ');
        
        // Update avatar
        const hoverAvatar = document.getElementById('previewHoverAvatar');
        const defaultAvatar = document.getElementById('previewDefaultAvatar');
        
        if (currentUser.photoURL) {
            hoverAvatar.src = currentUser.photoURL;
            hoverAvatar.style.display = 'block';
            defaultAvatar.style.display = 'none';
        } else {
            const firstLetter = currentUser.username.charAt(0).toUpperCase();
            const colors = ['#FFB900', '#FF8C00', '#F7630C', '#CA5010'];
            const color = colors[firstLetter.charCodeAt(0) % colors.length];
            
            hoverAvatar.style.display = 'none';
            defaultAvatar.style.display = 'flex';
            defaultAvatar.style.backgroundColor = color;
            defaultAvatar.textContent = firstLetter;
        }
        
        // Update stats
        document.getElementById('previewHoverAP').textContent = profile.ap || '0';
        document.getElementById('previewHoverDP').textContent = profile.dp || '0';
        document.getElementById('previewHoverGS').textContent = ((parseInt(profile.ap) || 0) + (parseInt(profile.dp) || 0)).toString();
        document.getElementById('previewHoverClass').textContent = profile.characterClass || 'Class not specified';
        
        // Update background image if screenshot exists
        const hoverCard = document.querySelector('#hoverCardPreview.profile-hover-card');
        if (profile.characterScreenshot) {
            hoverCard.style.backgroundImage = `url(${profile.characterScreenshot})`;
        } else {
            hoverCard.style.backgroundImage = '';
        }
    }

		// Gear score calculation
		function updateGearScore() {
			const ap = parseInt(document.getElementById('ap').value) || 0;
			const dp = parseInt(document.getElementById('dp').value) || 0;
			document.getElementById('gearScore').value = ap + dp;
		}

		// Event listeners for AP/DP changes
		document.getElementById('ap').addEventListener('input', updateGearScore);
		document.getElementById('dp').addEventListener('input', updateGearScore);

		// Screenshot upload handler
		document.getElementById('uploadScreenshotBtn').addEventListener('click', () => {
			document.getElementById('characterScreenshot').click();
		});

    document.getElementById('characterScreenshot').addEventListener('change', async (e) => {
        if (e.target.files && e.target.files[0]) {
            const file = e.target.files[0];
            if (file.size > 5 * 1024 * 1024) { // 5MB limit
                alert('Please select an image smaller than 5MB');
                return;
            }
            
            try {
                const formData = new FormData();
                formData.append("image", file);
    
                const response = await fetch("https://api.imgur.com/3/image", {
                    method: "POST",
                    headers: {
                        Authorization: `Client-ID 39f8c230782d6da`
                    },
                    body: formData
                });
    
                const data = await response.json();
                if (data.success) {
                    await database.ref(`profiles/${currentUser.uid}/characterScreenshot`).set(data.data.link);
                    
                    // Update preview
                    const screenshotPreview = document.getElementById('characterScreenshotPreview');
                    screenshotPreview.src = data.data.link;
                    screenshotPreview.style.display = 'block';
                    document.getElementById('screenshotPlaceholder').style.display = 'none';
                    
                    // Update hover card preview
                    const profileSnapshot = await database.ref(`profiles/${currentUser.uid}`).once('value');
                    updateHoverCardPreview({
                        ...profileSnapshot.val(),
                        characterScreenshot: data.data.link
                    });
                    
                    alert('Character screenshot uploaded successfully!');
                } else {
                    throw new Error(data.data.error || 'Failed to upload screenshot');
                }
            } catch (error) {
                console.error('Error uploading screenshot:', error);
                alert('Failed to upload screenshot: ' + error.message);
            }
        }
    });

		// Updated saveProfile function with BDO fields
		async function saveProfile(uid) {
			const profileData = {
				characterName: document.getElementById('characterName').value.trim(),
				characterClass: document.getElementById('characterClass').value.trim(),
				bio: document.getElementById('playerBio').value.trim(),
				ap: parseInt(document.getElementById('ap').value) || 0,
				dp: parseInt(document.getElementById('dp').value) || 0,
				gearScore: parseInt(document.getElementById('gearScore').value) || 0,
				lastUpdated: firebase.database.ServerValue.TIMESTAMP
			};
			
			try {
				await database.ref(`profiles/${uid}`).update(profileData);
				alert('Profile saved successfully!');
			} catch (error) {
				console.error('Error saving profile:', error);
				alert('Failed to save profile. Please try again.');
			}
		}

    async function uploadAvatar(uid, file) {
      if (!file) return;
      
      // Use your existing Imgur API implementation
      const formData = new FormData();
      formData.append("image", file);

      try {
        const response = await fetch("https://api.imgur.com/3/image", {
          method: "POST",
          headers: {
            Authorization: `Client-ID 39f8c230782d6da` // Your Imgur Client ID
          },
          body: formData
        });

        const data = await response.json();
        if (data.success) {
          // Update Firebase
          await database.ref(`users/${uid}/photoURL`).set(data.data.link);
          
          // Update the image source and currentUser
          document.getElementById('avatarImage').src = data.data.link;
          currentUser.photoURL = data.data.link;
          
          // Update the avatar in the user panel
          updateUserPanel();
          
          alert('Avatar updated successfully!');
        } else {
          throw new Error(data.data.error || 'Failed to upload avatar');
        }
      } catch (error) {
        console.error("Upload error:", error);
        alert('Error uploading avatar: ' + error.message);
      }
    }
  </script>
</body>
</html>
